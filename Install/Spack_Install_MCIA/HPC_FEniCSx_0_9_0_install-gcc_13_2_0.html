
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>üìñ FEniCSx v0.9.0 Installation on HPC (MCIA) &#8212; FEniCSx and GMSH Tutorials</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Install/Spack_Install_MCIA/HPC_FEniCSx_0_9_0_install-gcc_13_2_0';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="üìñ [Complex number] FEniCSx v0.9.0 Installation on HPC (MCIA)" href="HPC_FEniCSx_0_9_0_complex_numbers_install-gcc_13_2_0.html" />
    <link rel="prev" title="Installation Methods ‚öôÔ∏è" href="../Installation_Methods.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/fenics_logo.png" class="logo__image only-light" alt="FEniCSx and GMSH Tutorials - Home"/>
    <script>document.write(`<img src="../../_static/fenics_logo.png" class="logo__image only-dark" alt="FEniCSx and GMSH Tutorials - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    FEniCSx & GMSH Tutorial Repository (v0.9.0)
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Install_processes.html">Installation Guide for FEniCSx v0.9.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker_and_aliases.html">Docker workspace and aliases</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../Installation_Methods.html">Installation Methods</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Spack Installation (MCIA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="HPC_FEniCSx_0_9_0_complex_numbers_install-gcc_13_2_0.html">Complex Support - Spack Installation (MCIA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Spack_Install_FEniCSx/README.html">Spack Installation (CASSIOPEE)</a></li>

<li class="toctree-l2"><a class="reference internal" href="../WSL_Docker_installer/README.html">WSL Docker Installer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../WSL_Local_installer/README.html">WSL Local Installer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Windows_docker_installer/README.html">Windows Docker Installer</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Elastic_Incremental_Beam/README.html">Incremental Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Elastic_Multi_material_Beam/README.html">Material parameters depending on space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Hyper-Elastic_and_Elastic_Beam/README.html">Hyper-elastic and elastic beam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Hyper-elastic_beam/README.html">Hyper-elastic beam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Local_Refinement/README.html">Local refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Other_GMSH_Examples/README.html">Other GMSH Examples</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Penalty_contact_Beam/README.html">Penalty contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Stokes_2D/README.html">Stokes Problem (2D)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Stokes_3D/README.html">Stokes Problem (3D)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Stokes_Poiseuille/Readme.html">Poiseuille-Stokes Problem</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Terzaghi/README.html">Terzaghi Porous Media Mechanics Problem</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Thermique_stationnaire/README.html">Thermique stationnaire</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutoriels/Thermique_transitoire/README.html">Thermique transitoire</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ressources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Ressources_links.html">Comprehensive Resource Links</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Th0masLavigne/FEniCSx_GMSH_tutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Th0masLavigne/FEniCSx_GMSH_tutorials/issues/new?title=Issue%20on%20page%20%2FInstall/Spack_Install_MCIA/HPC_FEniCSx_0_9_0_install-gcc_13_2_0.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/Install/Spack_Install_MCIA/HPC_FEniCSx_0_9_0_install-gcc_13_2_0.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>üìñ FEniCSx v0.9.0 Installation on HPC (MCIA)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-use-guide-after-successful-installation">‚ö° Quick Use Guide (After Successful Installation)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#connect-to-the-hpc">üåê Connect to the HPC</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#access-files-online-upload-download">üìÅ Access files online (upload/download)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-local-file-system-mount-requires-sshfs">üìÅ Optional: Local File System Mount (Requires sshfs)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-job-sbatch-file-template">üíª Running a Job: Sbatch File Template</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-generated-module-recommended">Using the Generated Module (Recommended)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-spack-environment-directly">Using Spack Environment Directly</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installation-procedure-followed-for-the-mcia-cluster">Installation procedure followed for the MCIA cluster</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-an-interactive-session">Starting an Interactive Session</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleaning-the-environment">Cleaning the Environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-define-environment-variables-and-logging">Step 1: Define Environment Variables and Logging üìù</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-configure-external-modules-gcc-and-cmake">Step 2: Configure External Modules (GCC and CMake)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#automated-path-detection">Automated Path Detection üîó</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#forcing-cmake-path">Forcing CMake Path</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-initialize-and-configure-spack">Step 3: Initialize and Configure Spack ‚öôÔ∏è</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spack-setup-and-initialization">Spack Setup and Initialization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-packages-yaml-for-externals">Create <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code> for Externals</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-define-the-fenicsx-spack-environment-spack-yaml">Step 4: Define the FEniCSx Spack Environment (<code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>) üåø</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#complete-spack-yaml-configuration">Complete <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> Configuration</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-install-the-environment">Step 5: Install the environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-6-testing-and-validation">Step 6: Testing and Validation ‚úÖ</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-mpi-test">Basic MPI Test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-pmix-psm2-errors">Debugging PMIX/PSM2 Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-python-bindings">Missing Python bindings:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-7-module-deployment-propagating-to-tcl-on-mcia">Step 7: Module Deployment (Propagating to Tcl on MCIA)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleanup-and-reinstallation-for-maintenance">Cleanup and Reinstallation (For Maintenance) üóëÔ∏è</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resources">Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix-minimal-configuration-file">Appendix: (Minimal) Configuration file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#array-with-slurm">Array with Slurm</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fenicsx-v0-9-0-installation-on-hpc-mcia">
<h1>üìñ FEniCSx v0.9.0 Installation on HPC (MCIA)<a class="headerlink" href="#fenicsx-v0-9-0-installation-on-hpc-mcia" title="Link to this heading">#</a></h1>
<p>This document provides a comprehensive, step-by-step guide for installing <strong>FEniCSx v0.9.0</strong> using Spack on an HPC cluster, specifically referencing the <strong>MCIA</strong> environment.</p>
<p>This procedure utilizes external system modules for the compiler (<code class="docutils literal notranslate"><span class="pre">gcc&#64;13.2.0</span></code>) and build tools (<code class="docutils literal notranslate"><span class="pre">cmake&#64;3.27.6</span></code>), which is common practice on shared clusters.</p>
<blockquote>
<div><p><strong>‚ö†Ô∏è Resource Warning:</strong> Installing the complete environment (including <code class="docutils literal notranslate"><span class="pre">gmsh</span></code> and <code class="docutils literal notranslate"><span class="pre">opencascade</span></code>) may require significant resources (e.g., <strong><span class="math notranslate nohighlight">\(\ge\)</span> 16 GB RAM</strong>) and can last for <strong>more than 8 hours</strong>, particularly if dependencies like LLVM need to be recompiled. A minimal <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> is also provided for quick test.</p>
</div></blockquote>
<section id="quick-use-guide-after-successful-installation">
<h2>‚ö° Quick Use Guide (After Successful Installation)<a class="headerlink" href="#quick-use-guide-after-successful-installation" title="Link to this heading">#</a></h2>
<p>This section details how to load and use the FEniCSx environment, plus handy connection aliases for the cluster.</p>
<section id="connect-to-the-hpc">
<h3>üåê Connect to the HPC<a class="headerlink" href="#connect-to-the-hpc" title="Link to this heading">#</a></h3>
<p>You can create an alias to place in your local machine‚Äôs ~/.bash_aliases (or equivalent) to simplify connection to the cluster.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Connect to the HPC cluster</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">hpc_connect</span><span class="o">=</span><span class="s1">&#39;ssh &lt;username&gt;@curta.mcia.fr&#39;</span>
</pre></div>
</div>
<blockquote>
<div><p><em>Note:</em> Remember to replace <username> with your actual cluster username.</p>
</div></blockquote>
</section>
<section id="access-files-online-upload-download">
<h3>üìÅ Access files online (upload/download)<a class="headerlink" href="#access-files-online-upload-download" title="Link to this heading">#</a></h3>
<p>The <a class="reference external" href="https://curta3.mcia.fr/">https://curta3.mcia.fr/</a> web service allows users to access Curta from a web browser using the Open OnDemand software.</p>
</section>
<section id="optional-local-file-system-mount-requires-sshfs">
<h3>üìÅ Optional: Local File System Mount (Requires sshfs)<a class="headerlink" href="#optional-local-file-system-mount-requires-sshfs" title="Link to this heading">#</a></h3>
<p>These aliases use sshfs (SSH Filesystem) to mount your remote directories directly to a local folder (e.g., <code class="docutils literal notranslate"><span class="pre">$HOME/curta</span></code>), allowing you to browse and manage files as if they were local.</p>
<blockquote>
<div><p><em>Prerequisite:</em> You must have the sshfs tool installed on your local computer.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mount the remote HOME directory to $HOME/curta</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">hpc_home_mount</span><span class="o">=</span><span class="s1">&#39;sshfs &lt;username&gt;@curta.mcia.fr:/gpfs/home/&lt;username&gt; $HOME/curta&#39;</span>

<span class="c1"># Mount the remote SCRATCH directory to $HOME/curta</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">hpc_scratch_mount</span><span class="o">=</span><span class="s1">&#39;sshfs &lt;username&gt;@curta.mcia.fr:/scratch/&lt;username&gt; $HOME/curta&#39;</span>

<span class="c1"># Unmount the local folder</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">hpc_unmount</span><span class="o">=</span><span class="s1">&#39;fusermount -u $HOME/curta&#39;</span>
</pre></div>
</div>
<blockquote>
<div><p><em>Tip:</em> Before running a mount alias, ensure the local directory (<code class="docutils literal notranslate"><span class="pre">$HOME/curta</span></code>) exists: <code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span> <span class="pre">$HOME/curta</span></code>.</p>
</div></blockquote>
</section>
<section id="running-a-job-sbatch-file-template">
<h3>üíª Running a Job: Sbatch File Template<a class="headerlink" href="#running-a-job-sbatch-file-template" title="Link to this heading">#</a></h3>
<p>This template demonstrates how to properly configure a Slurm batch script to load the installed FEniCSx module and execute a parallel simulation.</p>
<blockquote>
<div><p>For multiple same execution with a parameter change (here mpirun tasks) refer to the really bottom (for convergence study). This could otherwise be used for python parameter.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1"># ==============================================================================</span>
<span class="c1"># 1. SLURM DIRECTIVES (MODIFY THESE FOR YOUR JOB)</span>
<span class="c1"># ==============================================================================</span>
<span class="c1">#SBATCH --job-name=fenicsx_test_two_nodes</span>
<span class="c1">#SBATCH --constraint=compute</span>
<span class="c1">##SBATCH -p i2m,i2m-resources</span>
<span class="c1">#SBATCH --partition=i2m,i2m-resources</span>
<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks=4                      # Total number of MPI processes (4 total)</span>
<span class="c1">##SBATCH --tasks-per-node=2              # Processes per node (2 per node on 2 nodes = 4 total)</span>
<span class="c1">#SBATCH --time=0-01:00:00               # Short runtime</span>
<span class="c1">#SBATCH --mem=16GB                       # Total memory reserved for the job</span>
<span class="c1">##SBATCH --mem-per-cpu=8g              # Alternative: Request memory per core</span>
<span class="c1">#SBATCH --output=slurm_test_%j.out</span>
<span class="c1">#SBATCH --error=slurm_test_%j.err</span>
<span class="c1">#SBATCH --mail-type=ALL</span>
<span class="c1">#SBATCH --mail-user=&lt;mail&gt;@&lt;domain&gt;.fr # Replace with your email address</span>
<span class="c1">#SBATCH --chdir=/gpfs/home/&lt;USERNAME&gt;/your_working_dir # Set the working directory</span>

<span class="c1"># Exit immediately if a command exits with a non-zero status</span>
<span class="nb">set</span><span class="w"> </span>-e

<span class="c1"># useful informations to print</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;==============================================================================&quot;</span><span class="w"> </span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;User:&quot;</span><span class="w"> </span><span class="nv">$USER</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Date:&quot;</span><span class="w"> </span><span class="sb">`</span>date<span class="sb">`</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Host:&quot;</span><span class="w"> </span><span class="sb">`</span>hostname<span class="sb">`</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Directory:&quot;</span><span class="w"> </span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;SLURM_JOBID:&quot;</span><span class="w"> </span><span class="nv">$SLURM_JOBID</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;SLURM_SUBMIT_DIR:&quot;</span><span class="w"> </span><span class="nv">$SLURM_SUBMIT_DIR</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;SLURM_JOB_NODELIST:&quot;</span><span class="w"> </span><span class="nv">$SLURM_JOB_NODELIST</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;==============================================================================&quot;</span><span class="w"> </span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- STARTING FENICSX MODULE TEST ---&quot;</span>

<span class="c1"># ==============================================================================</span>
<span class="c1"># 2. MODULE LOADING</span>
<span class="c1"># ==============================================================================</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Loading FEniCSx module (includes Python and Intel MPI)...&quot;</span>
<span class="c1"># Ensure a clean environment before loading the FEniCSx module</span>
module<span class="w"> </span>purge

<span class="c1"># Load the installed FEniCSx environment module</span>
<span class="c1"># This command automatically sets all PATHs, LD_LIBRARY_PATHs, and Python paths.</span>
module<span class="w"> </span>load<span class="w"> </span>fenicsx/0.9.0

<span class="c1"># ==============================================================================</span>
<span class="c1"># 3. EXECUTION </span>
<span class="c1"># ==============================================================================</span>

<span class="c1"># Print job parameters for verification</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting execution on </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2"> at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Number of nodes requested: </span><span class="nv">$SLURM_NNODES</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Total MPI tasks: </span><span class="nv">$SLURM_NTASKS</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Elementary test...&quot;</span>
mpirun<span class="w"> </span>-n<span class="w"> </span><span class="nv">$SLURM_NTASKS</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from mpi4py import MPI; import dolfinx; comm = MPI.COMM_WORLD; rank = comm.Get_rank(); size = comm.Get_size(); print(f&#39;Hello from rank {rank} out of {size} processes, dolfinx v {dolfinx.__version__}&#39;);from petsc4py import PETSc; from dolfinx.fem.petsc import assemble_vector; print(PETSc.ScalarType);&quot;</span>

<span class="c1"># Execute the parallel Python script using mpirun</span>
<span class="c1"># mpirun uses the OpenMPI instance loaded by the FEniCSx module</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running: mpirun -n </span><span class="nv">$SLURM_NTASKS</span><span class="s2"> python &lt;filename&gt;.py&quot;</span>

<span class="c1"># IMPORTANT: Ensure &lt;filename&gt;.py is in the directory specified by --chdir</span>
mpirun<span class="w"> </span>-n<span class="w"> </span><span class="nv">$SLURM_NTASKS</span><span class="w"> </span>python<span class="w"> </span>&lt;filename&gt;.py

<span class="c1"># ==============================================================================</span>
<span class="c1"># 4. POST-PROCESSING (OPTIONAL)</span>
<span class="c1"># ==============================================================================</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Job finished at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;After a job finishes you can see the real use of CPUs and memory&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;1. module load slurm/wrappers&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;2. seff &lt;job-id&gt;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;3. module purge&quot;</span>
</pre></div>
</div>
</section>
<section id="using-the-generated-module-recommended">
<h3>Using the Generated Module (Recommended)<a class="headerlink" href="#using-the-generated-module-recommended" title="Link to this heading">#</a></h3>
<ol class="arabic">
<li><p><strong>Load the FEniCSx module</strong> (after module propagation):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>fenicsx/0.9.0
</pre></div>
</div>
</li>
<li><p><strong>Execute Parallel Job:</strong> Use <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> or <code class="docutils literal notranslate"><span class="pre">srun</span></code> within your Slurm script.</p></li>
</ol>
<blockquote>
<div><p><em>Tip:</em> Some test files are available at <a class="reference external" href="https://github.com/Th0masLavigne/FEniCSx_GMSH_tutorials">Tutorials for test</a>.</p>
</div></blockquote>
</section>
<section id="using-spack-environment-directly">
<h3>Using Spack Environment Directly<a class="headerlink" href="#using-spack-environment-directly" title="Link to this heading">#</a></h3>
<p>This approach is required before the module file is deployed system-wide.</p>
<ol class="arabic">
<li><p><strong>Source the Spack setup:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>/gpfs/softs/contrib/apps/fenicsx/spack-src-28.10.2025/share/spack/setup-env.sh
</pre></div>
</div>
</li>
<li><p><strong>Activate the environment:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>--dir<span class="w"> </span>/gpfs/softs/contrib/apps/fenicsx/spack-config-28.10.2025/envs/fenicsx/0.9.0/shared
</pre></div>
</div>
</li>
<li><p><strong>Export for OpenMPI/PSM2 (Crucial on MCIA):</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">OMPI_MCA_orte_precondition_transports</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;%08x%08x-%08x%08x&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="si">${</span><span class="nv">SLURM_JOB_ID</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">SLURM_STEP_ID</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">SLURM_JOB_ID</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">SLURM_STEP_ID</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="k">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Export for NLOPT Python Bindings (If installed):</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>/gpfs/softs/contrib/apps/fenicsx/spack-src-28.10.2025/opt/spack/linux-skylake_avx512/nlopt-2.9.1-joq7eb4qexm46mtfyhukmc6zxabfcrve/lib64/python3.11/site-packages:<span class="nv">$PYTHONPATH</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="installation-procedure-followed-for-the-mcia-cluster">
<h2>Installation procedure followed for the MCIA cluster<a class="headerlink" href="#installation-procedure-followed-for-the-mcia-cluster" title="Link to this heading">#</a></h2>
<p>It is <strong>highly recommended</strong> to perform this installation within a long-running, stable interactive session.</p>
<section id="starting-an-interactive-session">
<h3>Starting an Interactive Session<a class="headerlink" href="#starting-an-interactive-session" title="Link to this heading">#</a></h3>
<p>Request sufficient resources for the build process (32GB RAM is recommended).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>srun<span class="w"> </span>--nodes<span class="o">=</span><span class="m">1</span><span class="w"> </span>--ntasks<span class="o">=</span><span class="m">16</span><span class="w"> </span>--time<span class="o">=</span><span class="m">2</span>-23:00:00<span class="w"> </span>--mem<span class="o">=</span>32G<span class="w"> </span>--pty<span class="w"> </span>/bin/bash<span class="w"> </span>-i
</pre></div>
</div>
<blockquote>
<div><p><strong>Tip:</strong> If you believe your job has frozen during a long-running step, you can reconnect to the same node using job overlap: <code class="docutils literal notranslate"><span class="pre">srun</span> <span class="pre">--pty</span> <span class="pre">--overlap</span> <span class="pre">--jobid</span> <span class="pre">&lt;jobid&gt;</span> <span class="pre">/bin/bash</span> <span class="pre">-i</span></code>
Find your <code class="docutils literal notranslate"><span class="pre">&lt;jobid&gt;</span></code> with <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">-u</span> <span class="pre">$USER</span></code>. You can then monitor the node with <code class="docutils literal notranslate"><span class="pre">top</span> <span class="pre">-u</span> <span class="pre">$USER</span></code>.</p>
</div></blockquote>
<p>Please note that the module deployment file is the only one that explcitly requires <strong>user modifications</strong> for paths and variables in case of changed version.</p>
</section>
<section id="cleaning-the-environment">
<h3>Cleaning the Environment<a class="headerlink" href="#cleaning-the-environment" title="Link to this heading">#</a></h3>
<p>To prevent conflicts with existing modules, especially OpenMPI versions, it is recommended to purge all loaded modules:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>purge
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="step-1-define-environment-variables-and-logging">
<h3>Step 1: Define Environment Variables and Logging üìù<a class="headerlink" href="#step-1-define-environment-variables-and-logging" title="Link to this heading">#</a></h3>
<p>We define all key installation paths and set up logging to capture almost all terminal output.</p>
<blockquote>
<div><p><strong>Note:</strong> The use of <code class="docutils literal notranslate"><span class="pre">2&gt;&amp;1</span> <span class="pre">|</span> <span class="pre">tee</span> <span class="pre">-a</span> <span class="pre">${REPORT_LOG_DIRECTORY}/${REPORT_LOG_FILENAME}</span></code> is appended to most commands below to ensure most output (stdout and stderr) are well captured in the log file, while also displaying it in the console. However, <code class="docutils literal notranslate"><span class="pre">export</span></code> and <code class="docutils literal notranslate"><span class="pre">source</span></code> does not work well if it is added.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================================</span>
<span class="c1"># Create the export variables</span>
<span class="c1"># ==================================================</span>

<span class="c1"># Specify the name of your log file.</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">REPORT_LOG_FILENAME</span><span class="o">=</span><span class="s2">&quot;report_install_fenicsx_</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%Y-%m-%d_%H-%M-%S&#39;</span><span class="k">)</span><span class="s2">_job-id_</span><span class="si">${</span><span class="nv">SLURM_JOBID</span><span class="si">}</span><span class="s2">.md&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="o">=</span><span class="s2">&quot;/gpfs/home/tlavigne002&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting log file creation at: </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># Choose the FEniCSx version to install</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FENICSX_VERSION</span><span class="o">=</span><span class="s2">&quot;0.9.0&quot;</span>

<span class="c1"># Path for cloning the Spack repository (including packages.yaml)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FENICSX_SPACK_ROOT</span><span class="o">=</span><span class="s2">&quot;/gpfs/softs/contrib/apps/fenicsx/spack-src-28.10.2025&quot;</span>

<span class="c1"># Path to packages.yaml defining externals</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SPACK_PACKAGES_YAML</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span><span class="s2">/etc/spack/packages.yaml&quot;</span>

<span class="c1"># Root path for the Spack environment configuration</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FENICSX_SPACK_CONFIG_ROOT</span><span class="o">=</span><span class="s2">&quot;/gpfs/softs/contrib/apps/fenicsx/spack-config-28.10.2025&quot;</span>

<span class="c1"># Directory where the Spack environment will be created (contains spack.yaml)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SPACK_ENV_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">FENICSX_SPACK_CONFIG_ROOT</span><span class="si">}</span><span class="s2">/envs/fenicsx/</span><span class="si">${</span><span class="nv">FENICSX_VERSION</span><span class="si">}</span><span class="s2">/shared&quot;</span>

<span class="c1"># Prefix for where the Tcl/Lmod modulefiles will be deployed</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">MODULEFILE_PREFIX</span><span class="o">=</span><span class="s2">&quot;/gpfs/softs/contrib/modulefiles/fenicsx&quot;</span>

<span class="c1"># Use the number of cores allocated by slurm for parallel compilation</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NCORES</span><span class="o">=</span><span class="nv">$SLURM_NTASKS</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;All variables set.&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="step-2-configure-external-modules-gcc-and-cmake">
<h3>Step 2: Configure External Modules (GCC and CMake)<a class="headerlink" href="#step-2-configure-external-modules-gcc-and-cmake" title="Link to this heading">#</a></h3>
<p>We need to identify the exact install paths for our external modules to correctly define them in <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code>.</p>
<p>On the cluster you can check the available modules using <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">avail</span></code>. Based on this exhaustive list you can identify the external packages you want to work with but be careful of potential conflicts if different compilers were used, or about consistency between verions.</p>
<p>In our case, we consider only gcc&#64;13.2.0 and cmake&#64;3.27.6. You can either automate the path identification to limit user error or copy paste them directly in tour packages.yaml by checking <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">show</span> <span class="pre">&lt;name_of_the_module&gt;</span></code>.</p>
<blockquote>
<div><p><em>Note:</em> For Openmpi, we use psm2 communication here, with pmix.</p>
</div></blockquote>
<section id="automated-path-detection">
<h4>Automated Path Detection üîó<a class="headerlink" href="#automated-path-detection" title="Link to this heading">#</a></h4>
<p>We use a helper function to reliably identify and export the paths for the external <code class="docutils literal notranslate"><span class="pre">gcc&#64;13.2.0</span></code> and <code class="docutils literal notranslate"><span class="pre">cmake&#64;3.27.6</span></code> modules. Execute the following block to find the exact prefix paths for the external modules:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>get_module_path<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>module<span class="w"> </span>show<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;(/gpfs/softs/[^[:space:]]+)&#39;</span><span class="w"> </span>-o<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">&#39;/modulefiles/&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/\/bin$//&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/:$//&#39;</span>
<span class="o">}</span>

<span class="c1"># Identify paths for CMake and GCC</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PREFIX_CMAKE</span><span class="o">=</span><span class="k">$(</span>get_module_path<span class="w"> </span>cmake/3.27.6<span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PREFIX_GCC</span><span class="o">=</span><span class="k">$(</span>get_module_path<span class="w"> </span>compilers/gcc/13.2.0<span class="k">)</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;CMAKE prefix identified: </span><span class="si">${</span><span class="nv">PREFIX_CMAKE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;GCC prefix identified: </span><span class="si">${</span><span class="nv">PREFIX_GCC</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># Ensure clean workspace</span>
module<span class="w"> </span>purge
</pre></div>
</div>
</section>
<section id="forcing-cmake-path">
<h4>Forcing CMake Path<a class="headerlink" href="#forcing-cmake-path" title="Link to this heading">#</a></h4>
<p>(Crucial Fix, see: <a class="reference external" href="https://fenicsproject.discourse.group/t/spack-installation-issue-for-fenicsx-0-9-0-py-fenics-basix-cmake-version-mismatch/18330">Spack Installation Issue for FEniCSx 0.9.0 (py-fenics-basix): CMake Version Mismatch - installation - FEniCS Project</a>)</p>
<p>This step resolves a common Spack/Python build issue where a system-wide CMake is chosen instead of the correct module version.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ensure force SKBUILD_CMAKE_EXECUTABLE for Python packages</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SKBUILD_CMAKE_EXECUTABLE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PREFIX_CMAKE</span><span class="si">}</span><span class="s2">/bin/cmake&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">SKBUILD_CMAKE_EXECUTABLE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SKBUILD_CMAKE_EXECUTABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># Ensure force CMAKE_EXECUTABLE for Spack itself</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CMAKE_EXECUTABLE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PREFIX_CMAKE</span><span class="si">}</span><span class="s2">/bin/cmake&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">CMAKE_EXECUTABLE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CMAKE_EXECUTABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># Ensure the correct CMake is at the front of the PATH</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PREFIX_CMAKE</span><span class="si">}</span><span class="s2">/bin:</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="step-3-initialize-and-configure-spack">
<h3>Step 3: Initialize and Configure Spack ‚öôÔ∏è<a class="headerlink" href="#step-3-initialize-and-configure-spack" title="Link to this heading">#</a></h3>
<section id="spack-setup-and-initialization">
<h4>Spack Setup and Initialization<a class="headerlink" href="#spack-setup-and-initialization" title="Link to this heading">#</a></h4>
<p>Clone Spack and source the environment setup script.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create necessary directories</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">FENICSX_SPACK_CONFIG_ROOT</span><span class="si">}</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">SPACK_ENV_DIR</span><span class="si">}</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># Clone or Update Spack</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span><span class="s2">/.git&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Cloning Spack (latest from git) into </span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span><span class="s2">...&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
<span class="w">    </span>git<span class="w"> </span>clone<span class="w"> </span>--depth<span class="o">=</span><span class="m">2</span><span class="w"> </span>https://github.com/spack/spack.git<span class="w"> </span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Spack is present. Updating...&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
<span class="w">    </span><span class="o">(</span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>git<span class="w"> </span>pull<span class="o">)</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
<span class="k">fi</span>

<span class="c1"># Disable local config to limit conflicts</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SPACK_DISABLE_LOCAL_CONFIG</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SPACK_USER_CONFIG_PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">FENICSX_SPACK_CONFIG_ROOT</span><span class="si">}</span>

<span class="c1"># Enable spack shell</span>
<span class="nb">source</span><span class="w"> </span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span>/share/spack/setup-env.sh<span class="w"> </span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Spack initialized (version: </span><span class="k">$(</span>spack<span class="w"> </span>--version<span class="k">)</span><span class="s2">)&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
spack<span class="w"> </span>debug<span class="w"> </span>report<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="create-packages-yaml-for-externals">
<h4>Create <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code> for Externals<a class="headerlink" href="#create-packages-yaml-for-externals" title="Link to this heading">#</a></h4>
<p>We define the externally provided compiler (<code class="docutils literal notranslate"><span class="pre">gcc</span></code>), build system (<code class="docutils literal notranslate"><span class="pre">cmake</span></code>), and job scheduler (<code class="docutils literal notranslate"><span class="pre">slurm</span></code>). Note the explicit paths for the compiler executables (<code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">cxx</span></code>, <code class="docutils literal notranslate"><span class="pre">fortran</span></code>) and the mandatory <code class="docutils literal notranslate"><span class="pre">languages='c,c++,fortran'</span></code> for the compiler.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Creating packages.yaml at </span><span class="si">${</span><span class="nv">SPACK_PACKAGES_YAML</span><span class="si">}</span><span class="s2">...&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; ${SPACK_PACKAGES_YAML} 2&gt;&amp;1 | tee -a ${REPORT_LOG_DIRECTORY}/${REPORT_LOG_FILENAME}</span>
<span class="s">packages:</span>
<span class="s">  # 1. Compiler (keep modules as it is a compiler)</span>
<span class="s">  gcc:</span>
<span class="s">    externals:</span>
<span class="s">    # include binutils. Beware, according to the ressources, need for binutils &gt;=2.40</span>
<span class="s">    - spec: gcc@13.2.0+binutils languages=&#39;c,c++,fortran&#39;</span>
<span class="s">      # From our variable</span>
<span class="s">      prefix: ${PREFIX_GCC}</span>
<span class="s">      extra_attributes:</span>
<span class="s">        compilers:</span>
<span class="s">          c: ${PREFIX_GCC}/bin/gcc</span>
<span class="s">          cxx: ${PREFIX_GCC}/bin/g++</span>
<span class="s">          fortran: ${PREFIX_GCC}/bin/gfortran</span>
<span class="s">      modules:</span>
<span class="s">      - compilers/gcc/13.2.0</span>
<span class="s">    buildable: false</span>
<span class="s">  cmake:</span>
<span class="s">    externals:</span>
<span class="s">    - spec: cmake@3.27.6</span>
<span class="s">      prefix: ${PREFIX_CMAKE}</span>
<span class="s">      modules: </span>
<span class="s">      - cmake/3.27.6</span>
<span class="s">    buildable: false</span>
<span class="s">  slurm:</span>
<span class="s">    externals:</span>
<span class="s">    - spec: slurm@23.11.5 sysconfdir=/etc/slurm</span>
<span class="s">      prefix: /usr</span>
<span class="s">    buildable: false</span>
<span class="s">EOF</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;packages.yaml created at </span><span class="si">${</span><span class="nv">SPACK_PACKAGES_YAML</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Content of packages.yaml:&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
cat<span class="w"> </span><span class="si">${</span><span class="nv">SPACK_PACKAGES_YAML</span><span class="si">}</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="step-4-define-the-fenicsx-spack-environment-spack-yaml">
<h3>Step 4: Define the FEniCSx Spack Environment (<code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>) üåø<a class="headerlink" href="#step-4-define-the-fenicsx-spack-environment-spack-yaml" title="Link to this heading">#</a></h3>
<p>This defines the full dependency graph for the complete FEniCSx stack, including visualization and extra physics libraries required by our team.</p>
<section id="complete-spack-yaml-configuration">
<h4>Complete <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> Configuration<a class="headerlink" href="#complete-spack-yaml-configuration" title="Link to this heading">#</a></h4>
<p>This is the complete environment set for MCIA, including specific librairies required by some PhDs of the team:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Creating complete spack.yaml at </span><span class="si">${</span><span class="nv">SPACK_ENV_DIR</span><span class="si">}</span><span class="s2">/spack.yaml...&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; ${SPACK_ENV_DIR}/spack.yaml 2&gt;&amp;1 | tee -a ${REPORT_LOG_DIRECTORY}/${REPORT_LOG_FILENAME}</span>
<span class="s"># spack.yaml for fenicsx/${FENICSX_VERSION}/shared</span>
<span class="s">spack:</span>
<span class="s">  specs:</span>
<span class="s">  # FEniCSx Core Components</span>
<span class="s">  - fenics-dolfinx@${FENICSX_VERSION}+adios2+petsc</span>
<span class="s">  - py-fenics-dolfinx@${FENICSX_VERSION}+petsc4py+slepc4py</span>

<span class="s">  - py-fenics-ffcx@${FENICSX_VERSION}</span>
<span class="s">  - fenics-ufcx</span>
<span class="s">  - py-fenics-ufl@2024.2.0</span>
<span class="s">  </span>
<span class="s">  - py-fenics-basix@${FENICSX_VERSION}</span>
<span class="s">  - fenics-basix@${FENICSX_VERSION}</span>
<span class="s">  </span>
<span class="s">  # see: https://jsdokken.com/dolfinx_mpc/README.html</span>
<span class="s">  # - py-dolfinx-mpc</span>

<span class="s">  # To respect omnipath, add fabrics psm2 and slurm management and PMI</span>
<span class="s">  - openmpi@5.0.8 fabrics=psm2 schedulers=slurm </span>
<span class="s">  </span>
<span class="s">  # Other Dependencies</span>
<span class="s">  - petsc+mumps+fortran+superlu-dist~trilinos</span>
<span class="s">  - adios2~sst+python</span>
<span class="s">  - gmsh+opencascade</span>
<span class="s">  - vtk@9.5.1+mpi+python+shared</span>
<span class="s">  - hdf5+hl+shared+mpi #by default, hdf5 was without hl causing crash</span>
<span class="s">  </span>
<span class="s">  # Common Python Libraries</span>
<span class="s">  - python</span>
<span class="s">  - py-pip</span>
<span class="s">  - py-setuptools</span>
<span class="s">  - py-wheel</span>
<span class="s">  - python-venv</span>
<span class="s">  - py-gmsh</span>
<span class="s">  - py-pygmsh</span>
<span class="s">  - py-numba</span>
<span class="s">  - py-scipy</span>
<span class="s">  - py-statsmodels</span>
<span class="s">  - py-matplotlib</span>
<span class="s">  - py-imageio</span>
<span class="s">  - py-adios4dolfinx</span>
<span class="s">  - py-trimesh</span>
<span class="s">  - py-rtree</span>
<span class="s">  - py-numpy</span>
<span class="s">  - py-pandas</span>
<span class="s">  - py-pyvista</span>
<span class="s">  - py-h5py</span>

<span class="s">  # Other Libraries</span>
<span class="s">  - nlopt+python</span>
<span class="s">  - neper</span>
<span class="s">  - py-pytz</span>
<span class="s">  - py-scikit-optimize</span>
<span class="s">  - py-seaborn</span>
<span class="s">  - py-python-pptx</span>

<span class="s">  config:</span>
<span class="s">    concretizer:</span>
<span class="s">      unify: true</span>
<span class="s">    env_vars:</span>
<span class="s">      # Crucial: Override environment variables to force the correct CMake path</span>
<span class="s">      set:</span>
<span class="s">        SKBUILD_CMAKE_EXECUTABLE: ${PREFIX_CMAKE}/bin/cmake</span>
<span class="s">        CMAKE_EXECUTABLE: ${PREFIX_CMAKE}/bin/cmake</span>
<span class="s">        PATH: ${PREFIX_CMAKE}/bin:$PATH</span>
<span class="s">EOF</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Content of spack.yaml:&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
cat<span class="w"> </span><span class="si">${</span><span class="nv">SPACK_ENV_DIR</span><span class="si">}</span>/spack.yaml<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
</pre></div>
</div>
<blockquote>
<div><p><em>Note:</em> You can browse <a class="reference external" href="https://packages.spack.io/">Spack Packages</a> to discover additional software available for installation.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Maintenance Note:</strong> If you modify <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code> or <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>, you must run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spack<span class="w"> </span>env<span class="w"> </span>deactivate
spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>-p<span class="w"> </span>--dir<span class="w"> </span><span class="si">${</span><span class="nv">SPACK_ENV_DIR</span><span class="si">}</span>
spack<span class="w"> </span>deconcretize<span class="w"> </span>-a<span class="w"> </span>-y
spack<span class="w"> </span>concretize
</pre></div>
</div>
<p>By doing so, you ensure having the updated spack tree.</p>
</div></blockquote>
</section>
</section>
<hr class="docutils" />
<section id="step-5-install-the-environment">
<h3>Step 5: Install the environment<a class="headerlink" href="#step-5-install-the-environment" title="Link to this heading">#</a></h3>
<p>We activate the environment, resolve dependencies (concretize), and start the installation.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Activate the environment. Use -p for persistent activation (recommended for interactive shells).</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;spack env activate -p --dir </span><span class="si">${</span><span class="nv">SPACK_ENV_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>-p<span class="w"> </span>--dir<span class="w"> </span><span class="si">${</span><span class="nv">SPACK_ENV_DIR</span><span class="si">}</span>

<span class="c1"># Concretize the environment to resolve the full dependency graph</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Concretizing environment...&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
spack<span class="w"> </span>concretize<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># Verify the externals (GCC/CMake) were respected</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Verify the externals are respected (should show &#39;E&#39; for externals):&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
spack<span class="w"> </span>find<span class="w"> </span>-c<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># Verify dependencies for a critical component (e.g., py-fenics-basix)</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Verify the cmake for basix:&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
spack<span class="w"> </span>spec<span class="w"> </span>py-fenics-basix<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># Start the installation</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting FEniCSx installation (using </span><span class="si">${</span><span class="nv">NCORES</span><span class="si">}</span><span class="s2"> cores for -j)...&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
<span class="c1"># Replace %gcc@13.2.0 by yours if needed.</span>
spack<span class="w"> </span>install<span class="w"> </span>-j<span class="si">${</span><span class="nv">NCORES</span><span class="si">}</span><span class="w"> </span>%gcc@13.2.0<span class="w"> </span>--fail-fast<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;FEniCSx installation complete. </span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%Y-%m-%d_%H-%M-%S&#39;</span><span class="k">)</span><span class="s2">. View installed packages at: </span><span class="si">${</span><span class="nv">FENICSX_SPACK_CONFIG_ROOT</span><span class="si">}</span><span class="s2">/envs/fenicsx/0.9.0/shared/.spack-env/view&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
</pre></div>
</div>
<blockquote>
<div><p><em>Note:</em> For VTK or LLVM for example, the installation times are quite long (up to 12 hours each).</p>
</div></blockquote>
<p>If you need more info about where is the package installed to check for example if multiply installed, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spack<span class="w"> </span>location<span class="w"> </span>-i<span class="w"> </span>openmpi
spack<span class="w"> </span>find<span class="w"> </span>-p<span class="w"> </span>openmpi
</pre></div>
</div>
<blockquote>
<div><p><strong>Rebuilding:</strong> If you need to rebuild core FEniCSx components from source (e.g., after updating Spack), use the <code class="docutils literal notranslate"><span class="pre">--overwrite</span></code> flag:
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">--overwrite</span> <span class="pre">-j${NCORES}</span> <span class="pre">fenics-basix</span> <span class="pre">py-fenics-basix</span> <span class="pre">py-fenics-ffcx</span> <span class="pre">fenics-ufcx</span> <span class="pre">py-fenics-ufl</span> <span class="pre">fenics-dolfinx</span> <span class="pre">py-fenics-dolfinx</span></code></p>
</div></blockquote>
<p>Some packages might fail to install probably due to fetching step. For these missing packages identified with <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">find</span> <span class="pre">-c</span></code>, you can reinstall immediatly them using (and now everything should be installed). For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spack<span class="w"> </span>install<span class="w"> </span>-j<span class="si">${</span><span class="nv">NCORES</span><span class="si">}</span><span class="w"> </span>%gcc@13.2.0<span class="w"> </span>gsl@2.8<span class="w"> </span>neper@4.10.1<span class="w"> </span>py-adios4dolfinx@0.9.4<span class="w"> </span>py-certifi@2025.7.14<span class="w"> </span>py-charset-normalizer@3.4.4<span class="w"> </span>py-gmsh@4.13.1<span class="w"> </span>py-h5py@3.13.0<span class="w"> </span>py-idna@3.10<span class="w"> </span>py-imageio@2.37.0<span class="w"> </span>py-mako@1.3.10<span class="w"> </span>py-meshio@5.0.1<span class="w"> </span>py-pkgconfig@1.5.5<span class="w"> </span>py-platformdirs@4.4.0<span class="w"> </span>py-poetry-core@2.2.0<span class="w"> </span>py-pooch@1.8.2<span class="w"> </span>py-pyaml@21.8.3<span class="w"> </span>py-pygmsh@7.1.17<span class="w"> </span>py-python-pptx@0.6.23<span class="w"> </span>py-pyvista@0.46.3<span class="w"> </span>py-pyyaml@6.0.3<span class="w"> </span>py-requests@2.32.5<span class="w"> </span>py-rtree@1.4.1<span class="w"> </span>py-scikit-optimize@0.9.0<span class="w"> </span>py-scooby@0.10.0<span class="w"> </span>py-seaborn@0.13.2<span class="w"> </span>py-trimesh@3.17.1<span class="w"> </span>py-typing-extensions@4.14.1<span class="w"> </span>py-urllib3@2.5.0<span class="w"> </span>py-xlsxwriter@3.1.7<span class="w"> </span>xcb-proto@1.17.0
</pre></div>
</div>
<blockquote>
<div><p><strong>Handling Installation Failures:</strong> If packages fail (often due to timeouts/network issues), re-force installation for the specific failed packages.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example to re-force installation for failed Python packages:</span>
spack<span class="w"> </span>install<span class="w"> </span>-j<span class="si">${</span><span class="nv">NCORES</span><span class="si">}</span><span class="w"> </span>%gcc@13.2.0<span class="w"> </span>py-requests@2.32.5<span class="w"> </span>py-idna@3.10<span class="w"> </span>py-rtree@1.4.1<span class="w"> </span><span class="o">[</span>...<span class="o">]</span>
</pre></div>
</div>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="step-6-testing-and-validation">
<h3>Step 6: Testing and Validation ‚úÖ<a class="headerlink" href="#step-6-testing-and-validation" title="Link to this heading">#</a></h3>
<p>Once installed, confirm the environment is functional, paying close attention to MPI/PSM2 configuration.</p>
<section id="basic-mpi-test">
<h4>Basic MPI Test<a class="headerlink" href="#basic-mpi-test" title="Link to this heading">#</a></h4>
<p>Ensure you are using the right psm2 communication:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ompi_info<span class="w"> </span>--param<span class="w"> </span>mtl<span class="w"> </span>psm2<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
<span class="c1"># expect MCA mtl: psm2 (MCA v2.1.0, API v2.0.0, Component v5.0.8)</span>
</pre></div>
</div>
<p>This test verifies <code class="docutils literal notranslate"><span class="pre">dolfinx</span></code> and <code class="docutils literal notranslate"><span class="pre">mpi4py</span></code> are correctly linked and running in parallel.</p>
<blockquote>
<div><p>Based on the following note: if you use spack directly and not module load, you need to define the following variable  before running mpirun (16 characters is required, see <a class="reference external" href="https://github.com/open-mpi/ompi/issues/13397">workaround pmix with psm2</a>.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the crucial PSM2/PMIX key if the module is not yet loaded</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SLURM_JOB_ID</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SLURM_STEP_ID</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">OMPI_MCA_orte_precondition_transports</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;%08x%08x-%08x%08x&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="si">${</span><span class="nv">SLURM_JOB_ID</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">SLURM_STEP_ID</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">SLURM_JOB_ID</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">SLURM_STEP_ID</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="k">)</span>
<span class="k">fi</span>

mpirun<span class="w"> </span>-n<span class="w"> </span><span class="nv">$SLURM_NTASKS</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from mpi4py import MPI; import dolfinx; comm = MPI.COMM_WORLD; rank = comm.Get_rank(); size = comm.Get_size(); print(f&#39;Hello from rank {rank} out of {size} processes, dolfinx v {dolfinx.__version__}&#39;)&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="debugging-pmix-psm2-errors">
<h4>Debugging PMIX/PSM2 Errors<a class="headerlink" href="#debugging-pmix-psm2-errors" title="Link to this heading">#</a></h4>
<p>If the PMIX transport error persists, test with a fallback MCA configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpirun<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span>--mca<span class="w"> </span>pml<span class="w"> </span>ob1<span class="w"> </span>--mca<span class="w"> </span>btl<span class="w"> </span>self,vader<span class="w"> </span>--mca<span class="w"> </span>orte_precondition_transports<span class="w"> </span><span class="nb">false</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from mpi4py import MPI; import dolfinx; comm = MPI.COMM_WORLD; rank = comm.Get_rank(); size = comm.Get_size(); print(f&#39;Hello from rank {rank} out of {size} processes, dolfinx v {dolfinx.__version__}&#39;)&quot;</span><span class="w">  </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="missing-python-bindings">
<h4>Missing Python bindings:<a class="headerlink" href="#missing-python-bindings" title="Link to this heading">#</a></h4>
<p>If a python binding is missing like for nlopt, if you use spack directly (and not module load that handles it already), add:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>/gpfs/softs/contrib/apps/fenicsx/spack-src-28.10.2025/opt/spack/linux-skylake_avx512/nlopt-2.9.1-joq7eb4qexm46mtfyhukmc6zxabfcrve/lib64/python3.11/site-packages:<span class="nv">$PYTHONPATH</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="step-7-module-deployment-propagating-to-tcl-on-mcia">
<h3>Step 7: Module Deployment (Propagating to Tcl on MCIA)<a class="headerlink" href="#step-7-module-deployment-propagating-to-tcl-on-mcia" title="Link to this heading">#</a></h3>
<p>This step generates the final Tcl modulefile for system-wide access. This file must be placed in a directory sourced by the cluster‚Äôs module system. Notably it sets the missing variables automatically and loads the view (i.e. the whole spack environment) under a single flag: <code class="docutils literal notranslate"><span class="pre">fenicsx/0.9.0</span></code>.</p>
<p>Create the target directory for the modulefile:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MODULEFILE_PREFIX</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Create the TCL module file. The use of ‚ÄòEOF‚Äô ensures that variables like ${FENICSX_VERSION} are expanded now, while internal logic like the ‚Äòif {[info exists env(SLURM_JOB_ID)]}‚Äô remains as literal text. This file is pointing to your spack install view and auto-generate the unique key for psm2/pmix. It also specifies some python bindings if missing like the one of nlopt in our case:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39; &gt; ${MODULEFILE_PREFIX}/${FENICSX_VERSION}</span>
<span class="s">#%Module1.0#####################################################################</span>
<span class="s">##</span>
<span class="s">## FEniCSx 0.9.0 ‚Äî modulefile (HPC shared Spack environment)</span>
<span class="s">##</span>

<span class="s">proc ModulesHelp { } {</span>
<span class="s">    puts stderr &quot;Loads FEniCSx ${FENICSX_VERSION} environment built with Spack&quot;</span>
<span class="s">    puts stderr &quot;Includes Dolfinx, Basix, UFL, ADIOS2, PETSc, etc.&quot;</span>
<span class="s">}</span>
<span class="s">module-whatis &quot;FEniCSx 0.9.0 ‚Äî Shared HPC Spack environment (Dolfinx stack)&quot;</span>

<span class="s"># ============================================================</span>
<span class="s"># Core environment variables</span>
<span class="s"># ============================================================</span>
<span class="s">setenv FENICSX_VERSION &quot;0.9.0&quot;</span>
<span class="s">setenv FENICSX_ENV_ROOT &quot;/gpfs/softs/contrib/apps/fenicsx/spack-config-28.10.2025/envs/fenicsx/0.9.0/shared&quot;</span>
<span class="s">setenv FENICSX_VIEW     &quot;$env(FENICSX_ENV_ROOT)/.spack-env/view&quot;</span>

<span class="s"># ============================================================</span>
<span class="s"># Path configuration</span>
<span class="s"># ============================================================</span>

<span class="s">prepend-path PATH              &quot;$env(FENICSX_VIEW)/bin&quot;</span>
<span class="s">prepend-path LD_LIBRARY_PATH   &quot;$env(FENICSX_VIEW)/lib&quot;</span>
<span class="s">prepend-path LD_LIBRARY_PATH   &quot;$env(FENICSX_VIEW)/lib64&quot;</span>
<span class="s">prepend-path CMAKE_PREFIX_PATH &quot;$env(FENICSX_VIEW)&quot;</span>
<span class="s">prepend-path PKG_CONFIG_PATH   &quot;$env(FENICSX_VIEW)/lib/pkgconfig&quot;</span>
<span class="s">prepend-path PKG_CONFIG_PATH   &quot;$env(FENICSX_VIEW)/lib64/pkgconfig&quot;</span>
<span class="s">prepend-path CPATH             &quot;$env(FENICSX_VIEW)/include&quot;</span>
<span class="s">prepend-path MANPATH           &quot;$env(FENICSX_VIEW)/share/man&quot;</span>

<span class="s"># Python integration</span>
<span class="s">prepend-path PYTHONPATH &quot;$env(FENICSX_VIEW)/lib/python3.11/site-packages&quot;</span>
<span class="s">#</span>
<span class="s"># NLOpt Python bindings (manual install outside view)</span>
<span class="s">prepend-path PYTHONPATH &quot;/gpfs/softs/contrib/apps/fenicsx/spack-src-28.10.2025/opt/spack/linux-skylake_avx512/nlopt-2.9.1-joq7eb4qexm46mtfyhukmc6zxabfcrve/lib64/python3.11/site-packages&quot;</span>

<span class="s"># ============================================================</span>
<span class="s"># UCX / PSM2 runtime tuning</span>
<span class="s"># ============================================================</span>

<span class="s"># Recommended UCX transport settings for Omni-Path</span>
<span class="s"># setenv UCX_TLS &quot;psm2,sm,self&quot;</span>
<span class="s"># setenv UCX_NET_DEVICES &quot;all&quot;</span>

<span class="s"># ============================================================</span>
<span class="s"># Optional: ensure unique PSM2 key under Slurm because Error obtaining unique transport key from PMIX (OMPI_MCA_orte_precondition_transports not present in the environment). when loading fenicsx</span>
<span class="s"># ============================================================</span>

<span class="s">if {[info exists env(SLURM_JOB_ID)]} {</span>
<span class="s">    # Default to step ID 0, which is correct for the main sbatch script shell</span>
<span class="s">    set stepid 0</span>
<span class="s">    if {[info exists env(SLURM_STEP_ID)]} {</span>
<span class="s">        set stepid $env(SLURM_STEP_ID)</span>
<span class="s">    }</span>
<span class="s">    </span>
<span class="s">    set jobid $env(SLURM_JOB_ID)</span>
<span class="s">    </span>
<span class="s">    # Key generation using Job ID and Step ID (defaulted to 0)</span>
<span class="s">    set key [format &quot;%08x%08x-%08x%08x&quot; $jobid $stepid $jobid $stepid]</span>
<span class="s">    setenv OMPI_MCA_orte_precondition_transports $key</span>
<span class="s">}</span>

<span class="s"># ============================================================</span>
<span class="s"># Environment info</span>
<span class="s"># ============================================================</span>

<span class="s">setenv FENICSX_HOME &quot;$env(FENICSX_VIEW)&quot;</span>
<span class="s">setenv FENICSX_SPACK_ENV &quot;$env(FENICSX_ENV_ROOT)&quot;</span>

<span class="s">puts &quot;echo &#39;============================================================&#39; &quot;</span>
<span class="s">puts &quot;echo &#39;Loaded FEniCSx 0.9.0 (shared Spack environment)&#39;&quot;</span>
<span class="s">puts &quot;echo &#39;============================================================&#39;&quot;</span>
<span class="s"># puts stderr &quot;&gt;&gt; Loaded FEniCSx 0.9.0 (shared Spack environment)&quot;</span>
<span class="s"># puts stderr &quot;&gt;&gt; Using view: $env(FENICSX_VIEW)&quot;</span>
<span class="s"># puts stderr &quot;&gt;&gt; Using OMPI_MCA_orte_precondition_transports: $key&quot;</span>
<span class="s">puts &quot;echo Using view: $env(FENICSX_VIEW)&quot;</span>
<span class="s">puts &quot;echo Using OMPI_MCA_orte_precondition_transports: $key&quot;</span>
<span class="s">puts &quot;echo &#39;# FEniCSx Core Components&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- fenics-dolfinx@0.9.0+adios2+petsc&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-fenics-dolfinx@0.9.0+petsc4py+slepc4py&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-fenics-ffcx@0.9.0&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- fenics-ufcx&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-fenics-ufl@2024.2.0&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-fenics-basix@0.9.0&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- fenics-basix@0.9.0&#39;&quot;</span>
<span class="s">puts  &quot; echo  To respect omnipath, add fabrics psm2 and slurm management and PMI&quot;</span>
<span class="s">puts  &quot; echo &#39;- openmpi@5.0.8 fabrics=psm2 schedulers=slurm &#39;&quot;</span>
<span class="s">puts  &quot; echo  Other Dependencies&quot;</span>
<span class="s">puts  &quot; echo &#39;- petsc+mumps+fortran+superlu-dist~trilinos&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- adios2~sst+python&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- gmsh+opencascade&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- vtk@9.5.1+mpi+python+shared&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- hdf5+hl+shared+mpi&#39; &quot;</span>
<span class="s">puts  &quot; echo  Common Python Libraries&quot;</span>
<span class="s">puts  &quot; echo &#39;- python&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-pip&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-setuptools&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-wheel&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- python-venv&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-gmsh&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-pygmsh&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-numba&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-scipy&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-statsmodels&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-matplotlib&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-imageio&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-adios4dolfinx&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-trimesh&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-rtree&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-numpy&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-pandas&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-pyvista&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-h5py&#39;&quot;</span>
<span class="s">puts  &quot; echo  Other Libraries&quot;</span>
<span class="s">puts  &quot; echo &#39;- nlopt+python&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- neper&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-pytz&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-scikit-optimize&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-seaborn&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;- py-python-pptx&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;============================================================&#39;&quot;</span>
<span class="s">puts  &quot; echo &#39;============================================================&#39;&quot;</span>

<span class="s">EOF</span>
</pre></div>
</div>
<blockquote>
<div><p>Trick for sbatch stability: STEP_ID not always defined =&gt; need to default it if not existing otherwise no key generated.</p>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="cleanup-and-reinstallation-for-maintenance">
<h3>Cleanup and Reinstallation (For Maintenance) üóëÔ∏è<a class="headerlink" href="#cleanup-and-reinstallation-for-maintenance" title="Link to this heading">#</a></h3>
<p>These commands are for maintenance purposes if a complete fresh start is required. <strong>Run these manually outside of the installation log script.</strong></p>
<p>The spack got broken because of a single package (let‚Äôs say pip install XXX). Reinstall only python and bindings:</p>
<blockquote>
<div><p>*Uninstalling a single package but its dependencies too for reinstall clean:  <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">uninstall</span>&#160; <span class="pre">--dependents</span> <span class="pre">-a</span> <span class="pre">python</span></code></p>
</div></blockquote>
<p>Full remove:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Uninstall all packages in the environment</span>
spack<span class="w"> </span>uninstall<span class="w"> </span>-j<span class="si">${</span><span class="nv">NCORES</span><span class="si">}</span><span class="w"> </span>%gcc@13.2.0<span class="w"> </span>--fail-fast<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># 2. Clean up temporary stages</span>
spack<span class="w"> </span>clean<span class="w"> </span>-s<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
spack<span class="w"> </span>clean<span class="w"> </span>-a<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>

<span class="c1"># 3. Deactivate the environment</span>
spack<span class="w"> </span>env<span class="w"> </span>deactivate<span class="w"> </span>

<span class="c1"># 4. Remove directories</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Removing Spack environment: </span><span class="si">${</span><span class="nv">SPACK_ENV_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
rm<span class="w"> </span>-rf<span class="w"> </span><span class="si">${</span><span class="nv">SPACK_ENV_DIR</span><span class="si">}</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Removing Spack configuration root: </span><span class="si">${</span><span class="nv">FENICSX_SPACK_CONFIG_ROOT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
rm<span class="w"> </span>-rf<span class="w"> </span><span class="si">${</span><span class="nv">FENICSX_SPACK_CONFIG_ROOT</span><span class="si">}</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Removing Spack source repository: </span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
rm<span class="w"> </span>-rf<span class="w"> </span><span class="si">${</span><span class="nv">FENICSX_SPACK_ROOT</span><span class="si">}</span>
</pre></div>
</div>
<p>Caution to remove your package only:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Removing Modules: </span><span class="si">${</span><span class="nv">MODULEFILE_PREFIX</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">FENICSX_VERSION</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REPORT_LOG_DIRECTORY</span><span class="si">}</span>/<span class="si">${</span><span class="nv">REPORT_LOG_FILENAME</span><span class="si">}</span>
rm<span class="w"> </span>-rf<span class="w"> </span><span class="si">${</span><span class="nv">MODULEFILE_PREFIX</span><span class="si">}</span>/<span class="si">${</span><span class="nv">FENICSX_VERSION</span><span class="si">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Spack Tutorial: <a class="reference external" href="https://spack-tutorial.readthedocs.io/en/latest/tutorial_configuration.html">spack-tutorial.readthedocs.io</a></p></li>
<li><p>Jack Hale Spack/Module Example: <a class="reference external" href="https://gist.github.com/jhale/23d4d7646e2dc05d0adc0395767d044a">gist.github.com/jhale/23d4d7646e2dc05d0adc0395767d044a</a></p></li>
<li><p>FEniCSx Tutorials for Testing: <a class="reference external" href="https://github.com/Th0masLavigne/FEniCSx_GMSH_tutorials">github.com/Th0masLavigne/FEniCSx_GMSH_tutorials</a></p></li>
<li><p>FEniCSx Discourse (CMake issue discussion): <a class="reference external" href="https://www.google.com/search?q=https://fenicsproject.discourse.group/t/spack-installation-issue-for-fenicsx-0-9-0-py-fenics-basix-cmake-version-mismatch/18330/2">fenicsproject.discourse.group</a></p></li>
<li><p>Spack Packages: <a class="reference external" href="https://packages.spack.io/">packages.spack.io</a></p></li>
<li><p>Set variable for openmpi: <a class="reference external" href="https://github.com/open-mpi/ompi/issues/13397">openmpi/pmix issue</a></p></li>
<li><p>J. Dokken MPC-constraint: <a class="reference external" href="https://jsdokken.com/dolfinx_mpc/README.html">Spack MPC-constraint</a></p></li>
</ul>
</section>
<hr class="docutils" />
<section id="appendix-minimal-configuration-file">
<h2>Appendix: (Minimal) Configuration file<a class="headerlink" href="#appendix-minimal-configuration-file" title="Link to this heading">#</a></h2>
<p>If you wish to only test the core FEniCSx installation without <code class="docutils literal notranslate"><span class="pre">gmsh</span></code> or other optional libraries, you can use a minimal configuration that excludes <code class="docutils literal notranslate"><span class="pre">gmsh+opencascade</span></code>, <code class="docutils literal notranslate"><span class="pre">py-gmsh</span></code>, <code class="docutils literal notranslate"><span class="pre">py-numba</span></code>, etc.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; ${SPACK_ENV_DIR}/spack_minimal.yaml 2&gt;&amp;1 | tee -a ${REPORT_LOG_DIRECTORY}/${REPORT_LOG_FILENAME}</span>
<span class="s"># spack_minimal.yaml for fenicsx/${FENICSX_VERSION}/shared</span>
<span class="s">spack:</span>
<span class="s">  specs:</span>
<span class="s">  - python</span>
<span class="s">  - py-pip</span>
<span class="s">  - py-setuptools</span>
<span class="s">  - py-wheel</span>
<span class="s">  - python-venv</span>
<span class="s">  - fenics-dolfinx@${FENICSX_VERSION}+adios2+petsc</span>
<span class="s">  - py-fenics-dolfinx@${FENICSX_VERSION}+petsc4py+slepc4py</span>
<span class="s">  - py-fenics-basix@${FENICSX_VERSION}</span>
<span class="s">  - fenics-basix@${FENICSX_VERSION}</span>
<span class="s">  - py-fenics-ufl@2024.2.0</span>
<span class="s">  - py-fenics-ffcx@${FENICSX_VERSION}</span>
<span class="s">  - petsc+mumps+fortran+superlu-dist~trilinos</span>
<span class="s">  - adios2~sst+python</span>
<span class="s">  # To respect omnipath, add fabrics psm2</span>
<span class="s">  - openmpi@5.0.8 fabrics=psm2 schedulers=slurm</span>

<span class="s">  config:</span>
<span class="s">    concretizer:</span>
<span class="s">      unify: true</span>
<span class="s">    env_vars:</span>
<span class="s">      set:</span>
<span class="s">        SKBUILD_CMAKE_EXECUTABLE: ${PREFIX_CMAKE}/bin/cmake</span>
<span class="s">        CMAKE_EXECUTABLE: ${PREFIX_CMAKE}/bin/cmake</span>
<span class="s">        PATH: ${PREFIX_CMAKE}/bin:$PATH</span>
<span class="s">EOF</span>
</pre></div>
</div>
</section>
<section id="array-with-slurm">
<h2>Array with Slurm<a class="headerlink" href="#array-with-slurm" title="Link to this heading">#</a></h2>
<p>This script is now configured to:</p>
<ul class="simple">
<li><p>Use the 0-3 array tasks to calculate a NOK_VALUE from 1 to 4.</p></li>
<li><p>In the final mpirun command, it uses mpirun -n ${NOK_VALUE} to run the simulation with a dynamically increasing number of processes (1, 2, 3, or 4) for each task.</p></li>
<li><p>It passes this dynamic number as the first command-line argument to your Python script.</p></li>
</ul>
<p>This setup is perfect for generating data to plot parallel efficiency or convergence over different core counts! Let me know if you‚Äôd like a reminder of how to read that NOK_VALUE inside your Python script.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1"># ==============================================================================</span>
<span class="c1"># 1. SLURM DIRECTIVES (MODIFY THESE FOR YOUR JOB)</span>
<span class="c1"># ==============================================================================</span>
<span class="c1">#SBATCH --job-name=fenicsx_convergence</span>
<span class="c1">#SBATCH --constraint=compute</span>
<span class="c1">#SBATCH --partition=i2m,i2m-resources</span>
<span class="c1"># --- JOB ARRAY PARAMETERS (800 tasks from 0 to 799) ---</span>
<span class="c1">#SBATCH --array=0-3 # for convergence analysis (i.e. use in mpirun) make it match --ntasks</span>
<span class="c1">#</span>
<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks=4                      # Total number of MPI processes (4 total)</span>
<span class="c1">##SBATCH --ntasks-per-node=1              # One master process per node (mpirun)</span>
<span class="c1">##SBATCH --tasks-per-node=2              # Processes per node (2 per node on 2 nodes = 4 total)</span>
<span class="c1">#SBATCH --time=0-01:00:00               # Short runtime</span>
<span class="c1">#SBATCH --mem=16GB                       # Total memory reserved for the job</span>
<span class="c1">##SBATCH --mem-per-cpu=8g              # Alternative: Request memory per core</span>
<span class="c1">#SBATCH --output=slurm_test_%j.out</span>
<span class="c1">#SBATCH --error=slurm_test_%j.err</span>
<span class="c1">#SBATCH --mail-type=ALL</span>
<span class="c1">#SBATCH --mail-user=&lt;mail&gt;@&lt;domain&gt;.fr # Replace with your email address</span>
<span class="c1">#SBATCH --chdir=/gpfs/home/&lt;USERNAME&gt;/your_working_dir # Set the working directory</span>

<span class="c1"># Exit immediately if a command exits with a non-zero status</span>
<span class="nb">set</span><span class="w"> </span>-e

<span class="c1"># Slurm environment variable for the task index (0-799)</span>
<span class="nv">SLURM_INDEX</span><span class="o">=</span><span class="nv">$SLURM_ARRAY_TASK_ID</span>

<span class="c1"># Calculate the 1-based index (1-800)</span>
<span class="c1"># This is the value that will be passed to the Python script</span>
<span class="nv">NOK_VALUE</span><span class="o">=</span><span class="k">$((</span><span class="nv">SLURM_INDEX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span>

<span class="c1"># useful informations to print</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;==============================================================================&quot;</span><span class="w"> </span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;User:&quot;</span><span class="w"> </span><span class="nv">$USER</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Date:&quot;</span><span class="w"> </span><span class="sb">`</span>date<span class="sb">`</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Host:&quot;</span><span class="w"> </span><span class="sb">`</span>hostname<span class="sb">`</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Directory:&quot;</span><span class="w"> </span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;SLURM_JOBID (Array ID):&quot;</span><span class="w"> </span><span class="nv">$SLURM_ARRAY_JOB_ID</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;SLURM_ARRAY_TASK_ID (0-799):&quot;</span><span class="w"> </span><span class="nv">$SLURM_INDEX</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Calculated NOK Value (1-800):&quot;</span><span class="w"> </span><span class="nv">$NOK_VALUE</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Total processes (cores) requested:&quot;</span><span class="w"> </span><span class="nv">$SLURM_CPUS_PER_TASK</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;==============================================================================&quot;</span><span class="w"> </span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- STARTING FENICSX MODULE TEST #</span><span class="si">${</span><span class="nv">NOK_VALUE</span><span class="si">}</span><span class="s2"> ---&quot;</span>

<span class="c1"># ==============================================================================</span>
<span class="c1"># 2. MODULE LOADING</span>
<span class="c1"># ==============================================================================</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Loading FEniCSx module (includes Python and Intel MPI)...&quot;</span>
<span class="c1"># Ensure a clean environment before loading the FEniCSx module</span>
module<span class="w"> </span>purge

<span class="c1"># Load the installed FEniCSx environment module</span>
<span class="c1"># This command automatically sets all PATHs, LD_LIBRARY_PATHs, and Python paths.</span>
module<span class="w"> </span>load<span class="w"> </span>fenicsx/0.9.0

<span class="c1"># ==============================================================================</span>
<span class="c1"># 3. EXECUTION </span>
<span class="c1"># ==============================================================================</span>

<span class="c1"># Print job parameters for verification</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting execution on </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2"> at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Number of nodes requested: </span><span class="nv">$SLURM_NNODES</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Total MPI tasks: </span><span class="nv">$SLURM_NTASKS</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Elementary test...&quot;</span>
mpirun<span class="w"> </span>-n<span class="w"> </span><span class="nv">$SLURM_NTASKS</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from mpi4py import MPI; import dolfinx; comm = MPI.COMM_WORLD; rank = comm.Get_rank(); size = comm.Get_size(); print(f&#39;Hello from rank {rank} out of {size} processes, dolfinx v {dolfinx.__version__}&#39;);from petsc4py import PETSc; from dolfinx.fem.petsc import assemble_vector; print(PETSc.ScalarType);&quot;</span>


<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- STARTING FENICSX SIMULATION #</span><span class="si">${</span><span class="nv">NOK_VALUE</span><span class="si">}</span><span class="s2"> ---&quot;</span>
<span class="c1"># Execute the parallel Python script using mpirun</span>
<span class="c1"># mpirun uses the OpenMPI instance loaded by the FEniCSx module</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running: mpirun -n </span><span class="nv">$SLURM_NTASKS</span><span class="s2"> python &lt;filename&gt;.py &quot;</span>

<span class="c1"># IMPORTANT: Ensure &lt;filename&gt;.py is in the directory specified by --chdir, add the nok_value for your export names for instance</span>
mpirun<span class="w"> </span>-n<span class="w"> </span><span class="si">${</span><span class="nv">NOK_VALUE</span><span class="si">}</span><span class="w"> </span>python<span class="w"> </span>&lt;filename&gt;.py<span class="w"> </span><span class="si">${</span><span class="nv">NOK_VALUE</span><span class="si">}</span>

<span class="c1"># ==============================================================================</span>
<span class="c1"># 4. POST-PROCESSING (OPTIONAL)</span>
<span class="c1"># ==============================================================================</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Job finished at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;After a job finishes you can see the real use of CPUs and memory&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;1. module load slurm/wrappers&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;2. seff &lt;job-id&gt;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;3. module purge&quot;</span>
</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Install/Spack_Install_MCIA"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../Installation_Methods.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Installation Methods ‚öôÔ∏è</p>
      </div>
    </a>
    <a class="right-next"
       href="HPC_FEniCSx_0_9_0_complex_numbers_install-gcc_13_2_0.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">üìñ [Complex number] FEniCSx v0.9.0 Installation on HPC (MCIA)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-use-guide-after-successful-installation">‚ö° Quick Use Guide (After Successful Installation)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#connect-to-the-hpc">üåê Connect to the HPC</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#access-files-online-upload-download">üìÅ Access files online (upload/download)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-local-file-system-mount-requires-sshfs">üìÅ Optional: Local File System Mount (Requires sshfs)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-job-sbatch-file-template">üíª Running a Job: Sbatch File Template</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-generated-module-recommended">Using the Generated Module (Recommended)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-spack-environment-directly">Using Spack Environment Directly</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installation-procedure-followed-for-the-mcia-cluster">Installation procedure followed for the MCIA cluster</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-an-interactive-session">Starting an Interactive Session</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleaning-the-environment">Cleaning the Environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-define-environment-variables-and-logging">Step 1: Define Environment Variables and Logging üìù</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-configure-external-modules-gcc-and-cmake">Step 2: Configure External Modules (GCC and CMake)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#automated-path-detection">Automated Path Detection üîó</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#forcing-cmake-path">Forcing CMake Path</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-initialize-and-configure-spack">Step 3: Initialize and Configure Spack ‚öôÔ∏è</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spack-setup-and-initialization">Spack Setup and Initialization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-packages-yaml-for-externals">Create <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code> for Externals</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-define-the-fenicsx-spack-environment-spack-yaml">Step 4: Define the FEniCSx Spack Environment (<code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>) üåø</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#complete-spack-yaml-configuration">Complete <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> Configuration</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-install-the-environment">Step 5: Install the environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-6-testing-and-validation">Step 6: Testing and Validation ‚úÖ</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-mpi-test">Basic MPI Test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-pmix-psm2-errors">Debugging PMIX/PSM2 Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-python-bindings">Missing Python bindings:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-7-module-deployment-propagating-to-tcl-on-mcia">Step 7: Module Deployment (Propagating to Tcl on MCIA)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleanup-and-reinstallation-for-maintenance">Cleanup and Reinstallation (For Maintenance) üóëÔ∏è</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resources">Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix-minimal-configuration-file">Appendix: (Minimal) Configuration file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#array-with-slurm">Array with Slurm</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Thomas Lavigne, PhD
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2025, Thomas Lavigne.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>